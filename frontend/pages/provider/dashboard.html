<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Provider Dashboard - CompostConnect</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              "compost-green": "#2E7D32",
              "compost-brown": "#795548",
              "compost-light": "#A5D6A7",
              "compost-dark": "#1B5E20",
              "compost-accent": "#FBC02D",
            },
          },
        },
      };
    </script>
    <link href="../../assets/css/styles.css" rel="stylesheet" />
    <script src="../../assets/js/jquery.min.js"></script>
    <!-- Load app.js AFTER jQuery -->
    <script src="../../assets/js/app.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body class="bg-gray-50 font-[Poppins]">
    <div id="header"></div>

    <div class="min-h-screen">
      <section class="py-10">
        <div class="container mx-auto px-4">
          <div
            class="flex flex-col md:flex-row items-start md:items-center justify-between mb-8"
          >
            <div>
              <h2 class="text-3xl font-bold text-compost-dark mb-2">
                Provider Dashboard
              </h2>
              <p class="text-gray-600">
                Grow your composting business and manage your services
              </p>
            </div>
            <div
              class="bg-compost-brown text-white rounded-lg px-4 py-3 shadow-md mt-4 md:mt-0"
            >
              <div class="flex items-center space-x-2">
                <i class="fas fa-seedling text-compost-accent"></i>
                <div>
                  <p class="font-medium">Provider Portal</p>
                  <p class="text-xs text-compost-light" id="status-badge">
                    Active
                  </p>
                </div>
              </div>
            </div>
          </div>

          <div id="provider-messages" class="mb-6"></div>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-10">
            <div class="lg:col-span-1">
              <div
                class="bg-white rounded-xl p-6 shadow-md border-l-4 border-compost-green mb-8"
              >
                <div class="flex justify-between items-center mb-4">
                  <h3 class="text-xl font-semibold text-compost-dark">
                    <i class="fas fa-user-circle mr-2 text-compost-green"></i
                    >Your Profile
                  </h3>
                  <a
                    href="../profile.html"
                    class="text-compost-green hover:text-compost-dark transition-colors"
                  >
                    <i class="fas fa-edit"></i>
                  </a>
                </div>
                <div id="profile-info" class="space-y-3">
                  <!-- Profile info will be populated by JavaScript -->
                  <p class="text-gray-500 italic">Loading profile...</p>
                </div>
              </div>

              <div
                class="bg-white rounded-xl p-6 shadow-md border-l-4 border-compost-accent"
              >
                <div class="flex justify-between items-center mb-4">
                  <h3 class="text-xl font-semibold text-compost-dark">
                    <i class="fas fa-leaf mr-2 text-compost-accent"></i
                    >Composting Impact
                  </h3>
                </div>
                <div class="space-y-4">
                  <div class="flex justify-between items-center">
                    <span class="text-gray-600">Waste Diverted</span>
                    <span
                      class="font-semibold text-compost-dark"
                      id="impact-diverted"
                      >... kg</span
                    >
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-gray-600">COâ‚‚ Saved</span>
                    <span
                      class="font-semibold text-compost-green"
                      id="impact-co2"
                      >... kg</span
                    >
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-gray-600">Compost Produced</span>
                    <span
                      class="font-semibold text-compost-brown"
                      id="impact-produced"
                      >... kg</span
                    >
                  </div>
                  <div class="mt-6 pt-4 border-t border-gray-100">
                    <p class="text-sm text-compost-dark italic">
                      Thank you for contributing to a greener future through
                      sustainable composting!
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <div class="lg:col-span-2">
              <div
                class="bg-white rounded-xl p-6 shadow-md border-l-4 border-compost-brown mb-8"
              >
                <div
                  class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4"
                >
                  <h3
                    class="text-xl font-semibold text-compost-dark mb-2 sm:mb-0"
                  >
                    <i class="fas fa-recycle mr-2 text-compost-brown"></i>Your
                    Services
                  </h3>
                  <a
                    href="create-service.html"
                    class="bg-compost-green hover:bg-compost-dark text-white px-4 py-2 rounded-lg text-sm transition-colors flex items-center"
                  >
                    <i class="fas fa-plus mr-2"></i>Add New Service
                  </a>
                </div>
                <p class="text-gray-600 mb-4">
                  Manage your composting services and offerings
                </p>
                <div
                  id="services-list"
                  class="space-y-4 max-h-96 overflow-y-auto"
                >
                  <!-- Services will be populated by JavaScript -->
                  <p class="text-gray-500 italic">Loading services...</p>
                </div>
              </div>

              <div
                class="bg-white rounded-xl p-6 shadow-md border-l-4 border-compost-dark"
              >
                <div class="flex justify-between items-center mb-4">
                  <h3 class="text-xl font-semibold text-compost-dark">
                    <i class="fas fa-clipboard-list mr-2 text-compost-dark"></i
                    >Service Requests
                  </h3>
                  <span
                    class="bg-compost-light text-compost-dark py-1 px-3 rounded-full text-sm font-medium"
                    id="request-count"
                    >... pending</span
                  >
                </div>
                <p class="text-gray-600 mb-4">
                  Manage customer requests for your composting services
                </p>
                <div class="flex gap-2 mb-4">
                  <button
                    class="px-3 py-1 bg-compost-light text-compost-dark rounded-lg hover:bg-compost-dark hover:text-white transition-colors filter-btn active"
                    data-filter="all"
                  >
                    All
                  </button>
                  <button
                    class="px-3 py-1 bg-gray-200 text-gray-700 rounded-lg hover:bg-compost-dark hover:text-white transition-colors filter-btn"
                    data-filter="pending"
                  >
                    Pending
                  </button>
                  <button
                    class="px-3 py-1 bg-gray-200 text-gray-700 rounded-lg hover:bg-compost-dark hover:text-white transition-colors filter-btn"
                    data-filter="accepted"
                  >
                    Accepted
                  </button>
                  <button
                    class="px-3 py-1 bg-gray-200 text-gray-700 rounded-lg hover:bg-compost-dark hover:text-white transition-colors filter-btn"
                    data-filter="completed"
                  >
                    Completed
                  </button>
                  <button
                    class="px-3 py-1 bg-gray-200 text-gray-700 rounded-lg hover:bg-compost-dark hover:text-white transition-colors filter-btn"
                    data-filter="cancelled"
                  >
                    Cancelled
                  </button>
                </div>
                <div
                  id="requests-list"
                  class="space-y-4 max-h-96 overflow-y-auto"
                >
                  <!-- Requests will be populated by JavaScript -->
                  <p class="text-gray-500 italic">Loading requests...</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <div id="footer"></div>
    <!-- Load footer dynamically -->

    <script>
      $(document).ready(function () {
        // Load header and footer


        let allRequests = []; // Store all fetched requests for filtering

        // --- Fetch Dashboard Data ---
        $.ajax({
          url: "http://localhost/compost_platform/api/provider/dashboard.php",
          method: "GET",
          dataType: "json",
          xhrFields: { withCredentials: true },
          success: function (response) {
            if (response.status === "success") {
              populateProfile(response.data.profile);
              populateServices(response.data.services);
              allRequests = response.data.requests; // Store all requests
              filterAndDisplayRequests("all"); // Initial display
              updateRequestCount(allRequests);
              // TODO: Populate impact data if available from API
            } else {
              showProviderMessage(
                "Error fetching dashboard data: " + response.message,
                "error"
              );
              // Redirect if unauthorized (e.g., not validated)
              if (response.message.includes("Unauthorized")) {
                setTimeout(
                  () => (window.location.href = "../login.html"),
                  2000
                );
              }
            }
          },
          error: function (xhr) {
            console.error("Dashboard fetch error:", xhr);
            showProviderMessage(
              "Failed to load dashboard data. Please check your connection or log in again.",
              "error"
            );
            if (xhr.status === 401 || xhr.status === 403) {
              // Unauthorized or Forbidden
              setTimeout(() => (window.location.href = "../login.html"), 2000);
            }
          },
        });

        // --- Populate Functions ---
        function populateProfile(profile) {
          const profileDiv = $("#profile-info");
          if (profile && profile.company_name) {
            profileDiv.html(`
                    <p><strong class="text-compost-dark">Company:</strong> ${
                      profile.company_name
                    }</p>
                    <p><strong class="text-compost-dark">Location:</strong> ${
                      profile.location || "Not set"
                    }</p>
                    <p><strong class="text-compost-dark">Contact:</strong> ${
                      profile.contact_number || "Not set"
                    }</p>
                    <p><strong class="text-compost-dark">Description:</strong> ${
                      profile.description || "No description provided."
                    }</p>
                `);
          } else {
            profileDiv.html(
              '<p class="text-gray-500 italic">Profile not yet completed. <a href="../profile.html" class="text-compost-green underline">Complete Profile</a></p>'
            );
          }
        }

        function populateServices(services) {
          const servicesList = $("#services-list");
          servicesList.empty(); // Clear loading message
          if (services && services.length > 0) {
            services.forEach((service) => {
              const serviceHtml = `
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 flex justify-between items-center">
                            <div>
                                <h4 class="font-semibold text-compost-dark">${
                                  service.title
                                }</h4>
                                <p class="text-sm text-gray-600">${service.description.substring(
                                  0,
                                  50
                                )}...</p>
                                <p class="text-sm text-compost-green font-medium">Price: $${parseFloat(
                                  service.price
                                ).toFixed(2)}</p>
                            </div>
                            <a href="edit-service.html?id=${
                              service.id
                            }" class="text-compost-green hover:text-compost-dark text-lg"><i class="fas fa-edit"></i></a>
                        </div>
                    `;
              servicesList.append(serviceHtml);
            });
          } else {
            servicesList.html(
              '<p class="text-gray-500 italic">You haven\'t added any services yet. <a href="create-service.html" class="text-compost-green underline">Add one now!</a></p>'
            );
          }
        }

        function displayRequests(requests) {
          const requestsList = $("#requests-list");
          requestsList.empty(); // Clear previous requests or loading message

          if (requests && requests.length > 0) {
            requests.forEach((request) => {
              let statusClass = "";
              let statusIcon = "";
              switch (request.status) {
                case "pending":
                  statusClass = "bg-yellow-100 text-yellow-800";
                  statusIcon = "fas fa-clock";
                  break;
                case "accepted":
                  statusClass = "bg-green-100 text-green-800";
                  statusIcon = "fas fa-check-circle";
                  break;
                case "completed":
                  statusClass = "bg-blue-100 text-blue-800";
                  statusIcon = "fas fa-check-double";
                  break;
                case "cancelled":
                  statusClass = "bg-red-100 text-red-800";
                  statusIcon = "fas fa-times-circle";
                  break;
                default:
                  statusClass = "bg-gray-100 text-gray-800";
                  statusIcon = "fas fa-question-circle";
              }

              // ** Add Accept/Reject buttons only if status is 'pending' **
              let actionButtons = "";
              if (request.status === "pending") {
                actionButtons = `
                            <button class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs transition-colors update-status-btn" data-request-id="${request.id}" data-new-status="accepted">
                                <i class="fas fa-check mr-1"></i>Accept
                            </button>
                            <button class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs transition-colors update-status-btn" data-request-id="${request.id}" data-new-status="cancelled">
                                <i class="fas fa-times mr-1"></i>Reject
                            </button>
                        `;
              }

              const requestHtml = `
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 request-item" data-status="${
                          request.status
                        }">
                            <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-2">
                                <h4 class="font-semibold text-compost-dark">${
                                  request.service_title
                                }</h4>
                                <span class="text-xs font-medium px-2 py-0.5 rounded ${statusClass}">
                                    <i class="${statusIcon} mr-1"></i>${
                request.status.charAt(0).toUpperCase() + request.status.slice(1)
              }
                                </span>
                            </div>
                            <p class="text-sm text-gray-600 mb-1">User: ${
                              request.user_username || "N/A"
                            } (${request.user_email || "N/A"})</p>
                            <p class="text-sm text-gray-600 mb-1">Requested: ${new Date(
                              request.created_at
                            ).toLocaleDateString()}</p>
                            ${
                              request.notes
                                ? `<p class="text-sm text-gray-500 italic mb-2">Notes: ${request.notes}</p>`
                                : ""
                            }
                            <div class="flex gap-2 mt-2">
                                ${actionButtons}
                            </div>
                        </div>
                    `;
              requestsList.append(requestHtml);
            });
          } else {
            requestsList.html(
              '<p class="text-gray-500 italic">No requests found matching the filter.</p>'
            );
          }
        }

        function updateRequestCount(requests) {
          const pendingCount = requests.filter(
            (req) => req.status === "pending"
          ).length;
          $("#request-count").text(`${pendingCount} pending`);
        }

        function showProviderMessage(message, type = "info") {
          const messageDiv = $("#provider-messages");
          const alertClass =
            type === "error"
              ? "bg-red-100 border-red-400 text-red-700"
              : "bg-blue-100 border-blue-400 text-blue-700";
          messageDiv
            .html(
              `
                <div class="${alertClass} border px-4 py-3 rounded relative" role="alert">
                    <span class="block sm:inline">${message}</span>
                </div>
            `
            )
            .show();
          // Optionally hide after a few seconds
          // setTimeout(() => messageDiv.fadeOut(), 5000);
        }

        // --- Event Handlers ---

        // Filter buttons for requests
        $(".filter-btn").click(function () {
          $(".filter-btn")
            .removeClass("active bg-compost-light text-compost-dark")
            .addClass("bg-gray-200 text-gray-700");
          $(this)
            .removeClass("bg-gray-200 text-gray-700")
            .addClass("active bg-compost-light text-compost-dark");

          const filter = $(this).data("filter");
          filterAndDisplayRequests(filter);
        });

        // Function to filter and display requests
        function filterAndDisplayRequests(filter) {
          let filteredRequests = [];
          if (filter === "all") {
            filteredRequests = allRequests;
          } else {
            filteredRequests = allRequests.filter(
              (req) => req.status === filter
            );
          }
          displayRequests(filteredRequests);
        }

        // ** Event listener for Accept/Reject buttons (using event delegation) **
        $("#requests-list").on("click", ".update-status-btn", function () {
          const button = $(this);
          const requestId = button.data("request-id");
          const newStatus = button.data("new-status");
          const actionText = newStatus === "accepted" ? "Accept" : "Reject";

          // Disable buttons temporarily
          button
            .prop("disabled", true)
            .siblings(".update-status-btn")
            .prop("disabled", true);
          button.html(
            `<i class="fas fa-spinner fa-spin mr-1"></i>${actionText}ing...`
          );

          updateRequestStatus(requestId, newStatus, button);
        });

        // ** Function to handle the API call for updating status **
        function updateRequestStatus(requestId, newStatus, buttonElement) {
          $.ajax({
            url: "http://localhost/compost_platform/api/provider/update_request_status.php",
            method: "POST",
            contentType: "application/json",
            xhrFields: { withCredentials: true }, // Send session cookie!
            data: JSON.stringify({
              request_id: requestId,
              status: newStatus,
            }),
            success: function (response) {
              if (response.status === "success") {
                showProviderMessage(response.message, "success");
                // Update the specific request item in the UI or refresh all data
                // Find the request in the master list and update its status
                const requestIndex = allRequests.findIndex(
                  (req) => req.id === requestId
                );
                if (requestIndex !== -1) {
                  allRequests[requestIndex].status = newStatus;
                }
                // Re-filter and display based on the current filter
                const currentFilter = $(".filter-btn.active").data("filter");
                filterAndDisplayRequests(currentFilter);
                updateRequestCount(allRequests); // Update pending count
              } else {
                showProviderMessage(
                  "Error updating status: " + response.message,
                  "error"
                );
                // Re-enable buttons on failure
                buttonElement
                  .prop("disabled", false)
                  .siblings(".update-status-btn")
                  .prop("disabled", false);
                buttonElement.html(
                  newStatus === "accepted"
                    ? '<i class="fas fa-check mr-1"></i>Accept'
                    : '<i class="fas fa-times mr-1"></i>Reject'
                );
              }
            },
            error: function (xhr) {
              console.error("Update Status Error:", xhr.responseText);
              let errorMsg = "An unknown error occurred while updating status.";
              try {
                const errorData = JSON.parse(xhr.responseText);
                errorMsg = "Error: " + errorData.message;
              } catch (e) {
                /* Ignore parsing error */
              }
              showProviderMessage(errorMsg, "error");
              // Re-enable buttons on failure
              buttonElement
                .prop("disabled", false)
                .siblings(".update-status-btn")
                .prop("disabled", false);
              buttonElement.html(
                newStatus === "accepted"
                  ? '<i class="fas fa-check mr-1"></i>Accept'
                  : '<i class="fas fa-times mr-1"></i>Reject'
              );
            },
          });
        }
      });
    </script>
  </body>
</html>
